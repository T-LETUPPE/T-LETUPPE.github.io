<!DOCTYPE html>
<html>
    <head>
        <title>Générateur d'abaques</title>
        <meta charset="utf-8">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
        <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.6.0.min.js"></script>
    </head>
    <body>
        <div class="container">
            Corrections de cap et facteur de base pour la navigation en VFR
            <div class="input-group">
                <span class="input-group-text">Vp = </span>
                <input type="number" class="form-control" min="40" max="200" onchange="UpdateDocument($(this).val())" placeholder="vitesse propre en kt">
                <span class="input-group-text">kts</span>
            </div>
            (= <span id="vitesseKPH"></span> km/h)
        </div>
        <div class="container">
            <table class="table table-bordered">
                <caption>Si le vent vient de la gauche, soustraire la dérive. Si le vent vient de la droite, ajouter la dérive. Les caps sont arrondis aux 5° les plus proches. Les Fb sont arrondis aux 0.01 les plus proches.</caption>
                <thead>
                    <tr id="angleAuVent">
                    </tr>
                </thead>
                <tbody id="tableCorr">
                </tbody>
            </table>
        </div>
    </body>
    <script>
        //Liste des angles au vent à calculer
        var degArr = []
        for (let i = 0; i <= 12; i++) {
            degArr.push(i*15)
        }
        var vitesseVentArr = [5, 10, 15, 20, 25, 30]
        
        //Remplis la table
        function fillTable(vp) {
            $("#tableCorr").empty()
            var i=0, j=0
            vitesseVentArr.forEach(vitesse => {
                var rowContent = ""
                rowContent += "<tr><th scope=\"row\">"+vitesse+"&nbsp;kt</th>"
                degArr.forEach(degree => {
                    rowContent += "<td style=\"text-align: center;\">X&nbsp;=&nbsp;"+GetDerive(vp, vitesseVentArr[i], degArr[j])+"°<br/>Fb&nbsp;=&nbsp;"+round(60/(vp-GetVentEffectif(vp, vitesseVentArr[i], degArr[j])), 0.01).toFixed(2)+"</td>"
                    j++
                });
                rowContent += "</tr>"
                $("#tableCorr").append(rowContent)
                i++
                j=0
            });
        }

        //Arrondi un nombre 'number' par pas de 'increment'
        function round(number, increment){
            return Math.round(number/increment)*increment
        }
        
        //Calcul de la dérive max Xmax=Fb*Vw
        function GetDeriveMax(vp, vw) {
            return Math.round((60/vp)*vw)
        }

        //Calcul de la dérive
        function GetDerive(vp, vw, angleV) {
            return round(GetDeriveMax(vp, vw)*Math.sin(DegToRad(angleV)), 5)
        }

        //Conversion de degrés en radians
        function DegToRad(deg) {
            return deg*Math.PI/180
        }

        //Calcul du vent effectif Veff=Xmax*cos(a)
        function GetVentEffectif(vp, vw, angleV) {
            return Math.round(vw*Math.cos(DegToRad(angleV)))
        }
        
        //Conversion de kts en kph
        function ConvertKtToKph(vitesse) {
            return Math.round(vitesse*1.852)
        }
        
        //Met à jour la page en fonction de la Vp renseignée
        function UpdateDocument(vp) {
            $("#vitesseKPH").text(ConvertKtToKph(vp))
            $("#angleAuVent").empty()
            $("#angleAuVent").append("<th scope=\"col\"></th>")
            degArr.forEach(element => {
                $("#angleAuVent").append("<th scope=\"col\">"+element+"°</th>")
            });
            fillTable(vp)
        }
    </script>
</html>
